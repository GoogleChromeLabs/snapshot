{"version":3,"file":"app.min.js","sources":["../src/view-state.ts","../src/constants.ts","../src/filters/filter-transform.ts","../src/promise-helpers.ts","../src/image-db.ts","../src/image-record.ts","../src/views/view.ts","../src/views/browse-view.ts","../src/camera-helper.ts","../src/views/capture-view.ts","../src/filters/image-shader.ts","../src/filters/named-filter.ts","../src/views/edit-view.ts","../src/views/upload-view.ts","../src/router.ts","../src/index.ts"],"sourcesContent":["/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport FilterTransform from './filters/filter-transform';\n\nexport default class ViewState {\n  id?: number;\n  transform?: FilterTransform;\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nexport default {\n  IMAGE_TYPE: 'image/jpeg',\n  SUPPORTS_IMAGE_CAPTURE: 'ImageCapture' in window,\n  SUPPORTS_MEDIA_DEVICES: 'mediaDevices' in navigator,\n};\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nconst random = (min: number, max: number): number => {\n  let result = Math.random();\n  result *= (max - min);\n  result += min;\n  return result;\n};\n\nexport default class FilterTransform {\n  static from(data: {[name: string]: number} | null) {\n    const result = new FilterTransform();\n\n    if (data) {\n      result.saturation = data.saturation || result.saturation;\n      result.warmth = data.warmth || result.warmth;\n      result.sharpen = data.sharpen || result.sharpen;\n      result.blur = data.blur || result.blur;\n      result.brightness = data.brightness || result.brightness;\n      result.contrast = data.contrast || result.contrast;\n      result.grey = data.grey || result.grey;\n      result.vignette = data.vignette || result.vignette;\n    }\n\n    return result;\n  }\n\n  saturation: number;\n  warmth: number;\n  sharpen: number;\n  blur: number;\n  brightness: number;\n  contrast: number;\n  grey: number;\n  vignette: number;\n\n  constructor() {\n    this.saturation = 1;\n    this.warmth = 0;\n    this.sharpen = 0;\n    this.blur = 1;\n    this.brightness = 1;\n    this.contrast = 1;\n    this.grey = 0.5;\n    this.vignette = 2;\n  }\n\n  randomize() {\n    this.saturation = random(0, 2);\n    this.warmth = random(-0.08, 0.08);\n    this.sharpen = random(-2, 2);\n    this.blur = random(0.01, 4);\n    this.brightness = random(0, 2);\n    this.contrast = random(0, 2);\n    this.grey = random(0, 1);\n    this.vignette = random(0.2, 2);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nexport function dataUrlToArrayBuffer(dataURI: string): ArrayBuffer {\n  const byteString = atob(dataURI.split(',')[1]);\n  const ia = new Uint8Array(byteString.length);\n  for (let i = 0; i < byteString.length; i++) {\n      ia[i] = byteString.charCodeAt(i);\n  }\n  return ia.buffer as ArrayBuffer;\n}\n\nexport async function canvasToBlob(canvas: HTMLCanvasElement, type: string): Promise<Blob> {\n  if (canvas.toBlob) {\n    const result: Promise<Blob> = new Promise((resolve) => {\n      canvas.toBlob((blob: Blob) => resolve(blob), type);\n    });\n    return result;\n  } else {\n    const dataURL = canvas.toDataURL(type);\n    const buffer = dataUrlToArrayBuffer(dataURL);\n    return new Blob([buffer], {type});\n  }\n}\n\nexport function blobToArrayBuffer(blob: Blob): Promise<ArrayBuffer> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.addEventListener('loadend', async (e: ProgressEvent) => {\n      resolve(reader.result);\n    });\n    reader.addEventListener('error', reject);\n    reader.readAsArrayBuffer(blob);\n  });\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport {blobToArrayBuffer} from './promise-helpers';\n\nconst DB_VERSION = 3;\n\nexport interface IListRecord {\n  id: number | null;\n  guid: string;\n\n  originalId: number | null;\n  editedId: number | null;\n  thumbnailId: number | null;\n\n  transform: {[name: string]: number} | null;\n}\n\ninterface IMediaRecord {\n  media: ArrayBuffer;\n  type: string;\n}\n\nclass ImageDB {\n  private dbPromise: Promise<IDBDatabase>;\n  private dbResolve: (value: IDBDatabase) => void;\n  private dbReject: (reason: any) => void;\n\n  constructor() {\n    const request = indexedDB.open('image-db', DB_VERSION);\n\n    this.dbPromise = new Promise((resolve, reject) => {\n      this.dbResolve = resolve;\n      this.dbReject = reject;\n\n      request.onerror = (reason) => this.dbReject(reason);\n      request.onupgradeneeded = (event) => this.createObjectStore(event);\n      request.onsuccess = (event) => this.dbOpened(request);\n    });\n  }\n\n  /**\n   * Store an image record in the database. If the `id` property of the\n   * record is not set, this will create a new entry. Returns the ID of the\n   * record.\n   */\n  storeRecord(record: IListRecord): Promise<number> {\n    if (record.id === null) {\n      delete record.id;\n    }\n    const promise: Promise<number> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['list'], 'readwrite');\n        const put = transaction.objectStore('list').put(record);\n\n        put.onsuccess = (event) => resolve(put.result);\n        put.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  retrieveRecord(id: number): Promise<IListRecord> {\n    const promise: Promise<IListRecord> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['list'], 'readonly');\n        const get = transaction.objectStore('list').get(id);\n\n        get.onsuccess = (event) => resolve(get.result);\n        get.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  async storeMedia(media: Blob, id?: number): Promise<number> {\n    const buffer = await blobToArrayBuffer(media);\n    const record = {\n      media: buffer,\n      type: media.type,\n    };\n    const promise: Promise<number> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['media'], 'readwrite');\n        const put = transaction.objectStore('media').put(record, id);\n\n        put.onsuccess = (event) => resolve(put.result);\n        put.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  retrieveMedia(id: number): Promise<Blob> {\n    const promise: Promise<Blob> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['media'], 'readonly');\n        const get = transaction.objectStore('media').get(id);\n\n        get.onsuccess = (event) => {\n          const record = get.result as IMediaRecord;\n          const blob = new Blob([record.media], {type: record.type});\n          resolve(blob);\n        };\n        get.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  all(): Promise<IListRecord[]> {\n    const promise: Promise<IListRecord[]> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['list'], 'readonly');\n        const open = transaction.objectStore('list').openCursor();\n        const results: IListRecord[] = [];\n\n        open.onsuccess = (event) => {\n          const cursor = open.result as IDBCursorWithValue;\n\n          if (cursor) {\n            results.push(cursor.value);\n            cursor.continue();\n          } else {\n            resolve(results);\n          }\n        };\n        open.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  private dbOpened(request: IDBOpenDBRequest) {\n    this.dbResolve(request.result);\n    this.dbPromise.then((db) => {\n      db.onerror = (reason) => this.error(reason);\n    });\n  }\n\n  private error(reason: Event) {\n    console.error(reason);\n  }\n\n  private createObjectStore(event: IDBVersionChangeEvent) {\n    const request: IDBOpenDBRequest = event.target as IDBOpenDBRequest;\n    const transaction: IDBTransaction = request.transaction;\n    const db: IDBDatabase = request.result;\n\n    // Added in version 3, so all paths need to create these stores\n    const mediaStore = db.createObjectStore('media', {autoIncrement: true});\n    const listStore = db.createObjectStore('list', {keyPath: 'id', autoIncrement: true});\n\n    if (event.oldVersion !== 0) {\n      // Can only recover from version 2, version 1 was too different\n      if (event.oldVersion === 2) {\n        this.upgrade2to3(mediaStore, listStore, transaction);\n      } else {\n        db.deleteObjectStore('images');\n      }\n    }\n  }\n\n  private upgrade2to3(mediaStore: IDBObjectStore, listStore: IDBObjectStore, transaction: IDBTransaction) {\n    const originalStore = transaction.objectStore('images');\n\n    // Get all existing records, move them to correct places\n    const readRequest = originalStore.openCursor();\n    readRequest.onerror = (reason) => this.error(reason);\n    readRequest.onsuccess = () => {\n      const cursor = readRequest.result as IDBCursorWithValue;\n      if (cursor) {\n        interface IOldRecord {\n          id: number;\n          original: ArrayBuffer;\n          edited: ArrayBuffer | null;\n          thumbnail: ArrayBuffer | null;\n          transform: {[name: string]: number} | null;\n        }\n        const oldRecord: IOldRecord = cursor.value;\n\n        const listRecord: IListRecord = {\n          editedId: null,\n          guid: '',\n          id: null,\n          originalId: null,\n          thumbnailId: null,\n          transform: oldRecord.transform,\n        };\n\n        const originalPut = mediaStore.put(oldRecord.original);\n        originalPut.onerror = (reason) => this.error(reason);\n        originalPut.onsuccess = () => {\n          listRecord.originalId = originalPut.result;\n\n          if (oldRecord.edited) {\n            const editedPut = mediaStore.put(oldRecord.edited);\n            editedPut.onerror = (reason) => this.error(reason);\n            editedPut.onsuccess = () => {\n              listRecord.editedId = editedPut.result;\n              listStore.put(listRecord);\n            };\n          } else {\n            listStore.put(listRecord);\n          }\n        };\n\n        cursor.continue();\n      } else {\n        transaction.db.deleteObjectStore('images');\n      }\n    };\n  }\n}\n\nexport const imageDB = new ImageDB();\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport FilterTransform from './filters/filter-transform';\nimport {IListRecord, imageDB} from './image-db';\n\nenum ImageState {\n  NotLoaded,\n  Loaded,\n  Changed,\n}\n\nexport default class ImageRecord {\n  static async fromDatabase(id: number) {\n    const data = await imageDB.retrieveRecord(id);\n    return ImageRecord.fromListRecord(data);\n  }\n\n  static fromListRecord(data: IListRecord) {\n    const result = new ImageRecord();\n\n    result.id = data.id;\n    result.guid = data.guid;\n\n    result.originalState = ImageState.NotLoaded;\n    result.editedState = ImageState.NotLoaded;\n    result.thumbnailState = ImageState.NotLoaded;\n\n    result.originalId = data.originalId;\n    result.editedId = data.editedId;\n    result.thumbnailId = data.thumbnailId;\n\n    result.transform = FilterTransform.from(data.transform);\n\n    return result;\n  }\n\n  static async getAll(): Promise<ImageRecord[]> {\n    const records = await imageDB.all();\n    const result: ImageRecord[] = [];\n\n    for (const record of records) {\n      result.push(ImageRecord.fromListRecord(record));\n    }\n\n    return result;\n  }\n\n  id: number | null;\n  guid: string;\n\n  originalState: ImageState;\n  editedState: ImageState;\n  thumbnailState: ImageState;\n\n  originalId: number | null;\n  editedId: number | null;\n  thumbnailId: number | null;\n\n  transform: FilterTransform | null;\n\n  private originalCache: Blob | null;\n  private editedCache: Blob | null;\n  private thumbnailCache: Blob | null;\n\n  constructor() {\n    this.id = null;\n    this.guid = '';\n\n    this.originalState = ImageState.Changed;\n    this.editedState = ImageState.Changed;\n    this.thumbnailState = ImageState.Changed;\n\n    this.originalId = null;\n    this.editedId = null;\n    this.thumbnailId = null;\n\n    this.transform = null;\n\n    this.originalCache = null;\n    this.editedCache = null;\n    this.thumbnailCache = null;\n  }\n\n  async getOriginal(): Promise<Blob | null> {\n    if (this.originalId && this.originalState === ImageState.NotLoaded) {\n      this.originalCache = await imageDB.retrieveMedia(this.originalId);\n      this.originalState = ImageState.Loaded;\n    }\n\n    return this.originalCache;\n  }\n\n  async getEdited(): Promise<Blob | null> {\n    if (this.editedId && this.editedState === ImageState.NotLoaded) {\n      this.editedCache = await imageDB.retrieveMedia(this.editedId);\n      this.editedState = ImageState.Loaded;\n    }\n\n    return this.editedCache || this.getOriginal();\n  }\n\n  async getThumbnail(): Promise<Blob | null> {\n    if (this.thumbnailId && this.thumbnailState === ImageState.NotLoaded) {\n      this.thumbnailCache = await imageDB.retrieveMedia(this.thumbnailId);\n      this.thumbnailState = ImageState.Loaded;\n    }\n\n    return this.thumbnailCache || this.getEdited();\n  }\n\n  setOriginal(media: Blob) {\n    // TODO: If we set the original, we should wipe out/delete any edited/thumbnail versions too.\n    this.originalCache = media;\n    this.originalState = ImageState.Changed;\n  }\n\n  setEdited(media: Blob) {\n    // TODO: If we set the edited, we should wipe out/delete any thumbnail version too.\n    this.editedCache = media;\n    this.editedState = ImageState.Changed;\n  }\n\n  async save(): Promise<void> {\n    if (this.originalState === ImageState.Changed && this.originalCache !== null) {\n      this.originalId = await imageDB.storeMedia(this.originalCache, this.originalId || undefined);\n    }\n\n    if (this.editedState === ImageState.Changed && this.editedCache !== null) {\n      this.editedId = await imageDB.storeMedia(this.editedCache, this.editedId || undefined);\n    }\n\n    if (this.thumbnailState === ImageState.Changed && this.thumbnailCache !== null) {\n      this.thumbnailId = await imageDB.storeMedia(this.thumbnailCache, this.thumbnailId || undefined);\n    }\n\n    let transformRecord: {[name: string]: number} = {};\n\n    if (this.transform) {\n      transformRecord = {...this.transform};\n    }\n\n    const id = await imageDB.storeRecord({\n      editedId: this.editedId,\n      guid: this.guid,\n      id: this.id,\n      originalId: this.originalId,\n      thumbnailId: this.thumbnailId,\n      transform: transformRecord,\n    });\n    this.id = id;\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport ViewState from '../view-state';\n\nexport default class View {\n  protected viewElement: HTMLElement;\n  private state?: ViewState;\n\n  constructor(viewElement: HTMLElement) {\n    this.viewElement = viewElement;\n  }\n\n  show(): void {\n    this.viewElement.classList.remove('hidden');\n  }\n\n  hide(): void {\n    this.viewElement.classList.add('hidden');\n  }\n\n  getState(): ViewState {\n    return this.state || new ViewState();\n  }\n\n  setState(state: ViewState) {\n    this.state = state;\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport constants from '../constants';\nimport ImageRecord from '../image-record';\nimport router from '../router';\nimport View from './view';\n\nexport default class BrowseView extends View {\n  private captureButton: HTMLButtonElement;\n  private uploadButton: HTMLButtonElement;\n  private emptyListElement: HTMLElement;\n  private listElement: HTMLElement;\n  private blobURLs: Set<string>;\n\n  constructor() {\n    super(document.getElementById('browse-view')!);\n\n    this.captureButton = document.getElementById('browse-capture-button') as HTMLButtonElement;\n    this.uploadButton = document.getElementById('browse-upload-button') as HTMLButtonElement;\n    this.emptyListElement = document.getElementById('empty-browse-list') as HTMLButtonElement;\n    this.listElement = document.getElementById('browse-list') as HTMLButtonElement;\n\n    if (!constants.SUPPORTS_MEDIA_DEVICES) {\n      this.captureButton.classList.add('hidden');\n    }\n\n    this.captureButton.addEventListener('click', () => this.captureClick());\n    this.uploadButton.addEventListener('click', () => this.uploadClick());\n\n    this.blobURLs = new Set();\n  }\n\n  async show() {\n    const photos = await ImageRecord.getAll();\n\n    if (photos.length === 0) {\n      this.emptyListElement.classList.remove('hidden');\n      this.listElement.classList.add('hidden');\n    } else {\n      this.emptyListElement.classList.add('hidden');\n      this.listElement.classList.remove('hidden');\n\n      for (const record of photos) {\n        const thumb = document.createElement('div');\n        thumb.classList.add('element');\n        thumb.addEventListener('click', () => router.visit(`/edit/${record.id}`));\n\n        const blob = await record.getThumbnail();\n        if (blob) {\n          const url = URL.createObjectURL(blob);\n          const image = document.createElement('img');\n          image.src = url;\n          thumb.appendChild(image);\n          this.blobURLs.add(url);\n        } else {\n          // TODO: Handle this error condition\n        }\n        this.listElement.appendChild(thumb);\n      }\n    }\n\n    super.show();\n  }\n\n  hide() {\n    super.hide();\n    // TODO: Have a good think about this. The strategy here is to remove all\n    // child elements when we hide, because smaller DOM seems like a win for the\n    // rest of the app. But really we probably want a recycler instead...\n    while (this.listElement.hasChildNodes()) {\n      this.listElement.removeChild(this.listElement.lastChild!);\n    }\n    for (const url of this.blobURLs) {\n      URL.revokeObjectURL(url);\n    }\n    this.blobURLs.clear();\n  }\n\n  captureClick() {\n    router.visit('/capture');\n  }\n\n  uploadClick() {\n    router.visit('/upload');\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport constants from './constants';\nimport {canvasToBlob} from './promise-helpers';\n\nconst streamConstraints: MediaStreamConstraints = {\n  video: {\n    deviceId: '',\n    facingMode: ['user', 'environment'],\n    height: {ideal: 1080},\n    width: {ideal: 1920},\n  },\n};\n\nlet supportedConstraints: MediaTrackSupportedConstraints = {};\n\nif (constants.SUPPORTS_MEDIA_DEVICES) {\n  supportedConstraints = navigator.mediaDevices.getSupportedConstraints();\n}\n\nexport default class CameraHelper {\n  flash: FillLightMode;\n\n  private stream: MediaStream | null;\n  private track: MediaStreamTrack | null;\n  private trackConstraints: MediaTrackSettings;\n  private photoCapabilities: PhotoCapabilities | null;\n\n  constructor() {\n    this.stream = null;\n    this.track = null;\n\n    this.photoCapabilities = null;\n    this.trackConstraints = {};\n\n    this.flash = 'off';\n  }\n\n  async getCameras() {\n    let devices: MediaDeviceInfo[] = [];\n\n    if (constants.SUPPORTS_MEDIA_DEVICES) {\n      devices = await navigator.mediaDevices.enumerateDevices();\n      devices = devices.filter((device) => device.kind === 'videoinput');\n    }\n\n    return devices;\n  }\n\n  async takePhoto(video: HTMLVideoElement): Promise<Blob | null> {\n    if (!constants.SUPPORTS_MEDIA_DEVICES) {\n      return null;\n    }\n\n    if (constants.SUPPORTS_IMAGE_CAPTURE) {\n      const stream = video.srcObject;\n\n      if (!stream) {\n        return null;\n      }\n\n      const track = stream.getVideoTracks()[0];\n      const capture = new ImageCapture(track);\n      const settings: PhotoSettings = {};\n\n      if (this.photoCapabilities) {\n        if (this.photoCapabilities.fillLightMode.includes(this.flash)) {\n          settings.fillLightMode = this.flash;\n        }\n      }\n\n      return await capture.takePhoto(settings);\n    } else {\n      const canvas = document.createElement('canvas');\n      const context = canvas.getContext('2d')!;\n      canvas.width = video.videoWidth;\n      canvas.height = video.videoHeight;\n      context.drawImage(video, 0, 0);\n\n      return await canvasToBlob(canvas, constants.IMAGE_TYPE);\n    }\n  }\n\n  stopStream() {\n    if (this.stream) {\n      for (const track of this.stream.getVideoTracks()) {\n        track.stop();\n      }\n    }\n  }\n\n  async startStream(deviceId: string) {\n    this.stopStream();\n\n    (streamConstraints.video as MediaTrackConstraints).deviceId = deviceId;\n\n    const stream = await navigator.mediaDevices.getUserMedia(streamConstraints);\n    this.stream = stream;\n    this.track = stream.getVideoTracks()[0];\n\n    if (constants.SUPPORTS_IMAGE_CAPTURE) {\n      const capture = new ImageCapture(this.track);\n      this.photoCapabilities = await capture.getPhotoCapabilities();\n    }\n\n    this.trackConstraints = {};\n    return stream;\n  }\n\n  getPhotoCapabilities(): {flash: FillLightMode[], redEyeReduction: boolean} {\n    if (this.photoCapabilities) {\n      return {\n        flash: this.photoCapabilities.fillLightMode,\n        redEyeReduction: this.photoCapabilities.redEyeReduction === 'controllable',\n      };\n    }\n\n    return {\n      flash: [],\n      redEyeReduction: false,\n    };\n  }\n\n  getSettings(): MediaTrackSettings {\n    if (!this.track || !this.track.getSettings) {\n      return {};\n    }\n    return this.track.getSettings();\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport CameraHelper from '../camera-helper';\nimport ImageRecord from '../image-record';\nimport router from '../router';\nimport View from './view';\n\nexport default class CaptureView extends View {\n  private videoElement: HTMLVideoElement;\n  private videoElement2: HTMLVideoElement;\n  private takePhotoButton: HTMLButtonElement;\n  private cameraChooseButton: HTMLButtonElement;\n  private mirrorButton: HTMLButtonElement;\n  private flashButton: HTMLButtonElement;\n  private closeButton: HTMLButtonElement;\n\n  private cameraHelper: CameraHelper;\n\n  private devicesPromise: Promise<MediaDeviceInfo[]>;\n  private currentDevice: MediaDeviceInfo | null;\n\n  constructor() {\n    super(document.getElementById('capture-view')!);\n    this.videoElement = this.viewElement.querySelector('video#preview')! as HTMLVideoElement;\n    this.videoElement2 = this.viewElement.querySelector('video#preview2')! as HTMLVideoElement;\n    this.takePhotoButton = document.getElementById('capture-button')! as HTMLButtonElement;\n    this.cameraChooseButton = document.getElementById('camera-choose-button')! as HTMLButtonElement;\n    this.mirrorButton = document.getElementById('capture-mirror-button')! as HTMLButtonElement;\n    this.flashButton = document.getElementById('capture-flash-button')! as HTMLButtonElement;\n    this.closeButton = document.getElementById('capture-view-close')! as HTMLButtonElement;\n\n    this.videoElement2.classList.add('hidden');\n\n    this.cameraHelper = new CameraHelper();\n\n    this.takePhotoButton.addEventListener('click', () => this.takePhoto());\n    this.cameraChooseButton.addEventListener('click', () => this.toggleCameraChooser());\n    this.mirrorButton.addEventListener('click', () => this.toggleMirror());\n    this.flashButton.addEventListener('click', () => this.toggleFlash());\n    this.closeButton.addEventListener('click', () => this.close());\n\n    this.devicesPromise = this.getDevices();\n    this.currentDevice = null;\n  }\n\n  show() {\n    this.devicesPromise.then((devices) => {\n      this.chooseCamera(devices[0]);\n    });\n    super.show();\n  }\n\n  hide() {\n    this.cameraHelper.stopStream();\n    this.videoElement.pause();\n    super.hide();\n  }\n\n  async getDevices() {\n    const cameras = await this.cameraHelper.getCameras();\n\n    if (cameras.length < 2) {\n      this.cameraChooseButton.classList.add('hidden');\n    } else {\n      this.cameraChooseButton.classList.remove('hidden');\n    }\n\n    return cameras;\n  }\n\n  async takePhoto() {\n    const blob = await this.cameraHelper.takePhoto(this.videoElement);\n    if (blob) {\n      this.storeResult(blob);\n    } else {\n      // TODO: This is an unhandled error condition\n    }\n  }\n\n  async toggleCameraChooser() {\n    // Four possible cases\n    // 1. No camera! This view shouldn't even come up, we need a fallback UI\n    // 2. One camera. Button should be hidden.\n    // 3. Two cameras. Clicking button is a simple toggle.\n    // 4. Three or more cameras. Present a chooser with the names and/or\n    //    features of the cameras.\n    // TODO: Need to change the button to reflect the kind of camera that will\n    // be selected.\n    // TODO: Need to decide what happens if we change camera while recording\n    const devices = await this.devicesPromise;\n    if (devices.length < 2) {\n      return;\n    }\n\n    if (this.currentDevice) {\n      const currentIndex = devices.indexOf(this.currentDevice);\n\n      // TODO: Should show chooser for many devices, not just cycle\n      this.chooseCamera(devices[(currentIndex + 1) % devices.length]);\n    } else {\n      this.chooseCamera(devices[0]);\n    }\n  }\n\n  close() {\n    router.visit(`/browse`);\n  }\n\n  private async chooseCamera(camera: MediaDeviceInfo) {\n    this.currentDevice = camera;\n    await this.startStream(this.currentDevice.deviceId);\n    const photoCapabilities = this.cameraHelper.getPhotoCapabilities();\n    const settings = this.cameraHelper.getSettings();\n    if (settings.facingMode === 'user') {\n      this.videoElement.classList.add('mirror');\n    } else {\n      this.videoElement.classList.remove('mirror');\n    }\n    this.flashButton.classList.remove('flash-flash', 'flash-off', 'flash-auto');\n    this.flashButton.classList.add(`flash-${this.cameraHelper.flash}`);\n    if (photoCapabilities.flash.length > 0) {\n      this.flashButton.classList.remove('hidden');\n    } else {\n      this.flashButton.classList.add('hidden');\n    }\n  }\n\n  private async storeResult(blob: Blob) {\n    const record = new ImageRecord();\n    record.setOriginal(blob);\n    await record.save();\n    router.visit(`/edit/${record.id}`);\n  }\n\n  private async startStream(deviceId: string) {\n    const stream = await this.cameraHelper.startStream(deviceId);\n    this.videoElement2.srcObject = stream;\n    return new Promise((resolve) => {\n      this.videoElement2.onloadedmetadata = () => {\n        const temp = this.videoElement;\n        this.videoElement = this.videoElement2;\n        this.videoElement2 = temp;\n        this.videoElement.play();\n        this.videoElement.classList.remove('hidden');\n        this.videoElement2.classList.add('hidden');\n        this.videoElement2.pause();\n        resolve();\n      };\n    });\n  }\n\n  private toggleMirror() {\n    this.videoElement.classList.toggle('mirror');\n  }\n\n  private toggleFlash() {\n    this.flashButton.classList.remove(`flash-${this.cameraHelper.flash}`);\n    const photoCapabilities = this.cameraHelper.getPhotoCapabilities();\n    let index = photoCapabilities.flash.indexOf(this.cameraHelper.flash);\n    index = (index + 1) % photoCapabilities.flash.length;\n    this.cameraHelper.flash = photoCapabilities.flash[index];\n    this.flashButton.classList.add(`flash-${this.cameraHelper.flash}`);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nconst BASE_VERTEX_SHADER = `\nattribute vec2 position;\nattribute vec2 uv;\n\nvarying vec2 texCoords;\n\nvoid main() {\n  gl_Position = vec4(position, 0, 1.0);\n  texCoords = uv;\n}`;\n\nconst BASE_FRAGMENT_SHADER = `\nprecision highp float;\n\nvarying vec2 texCoords;\n\nuniform sampler2D textureSampler;\n\nvoid main() {\n  gl_FragColor = texture2D(textureSampler, texCoords);\n}`;\n\nconst POSITIONS = new Float32Array([-1, -1, -1, 1, 1, 1, 1, -1]);\nconst UVS = new Float32Array([0, 1, 0, 0, 1, 0, 1, 1]);\nconst INDEX = new Uint16Array([0, 1, 2, 0, 2, 3]);\n\nclass UniformInfo {\n  type: GLenum;\n  location: WebGLUniformLocation;\n}\n\nexport default class ImageShader {\n  canvas: HTMLCanvasElement;\n  context: WebGLRenderingContext;\n\n  private textureId: WebGLTexture;\n  private programId: WebGLProgram;\n  private vertShader: string;\n  private fragShader: string;\n\n  private uniformLocations: Map<string, UniformInfo>;\n  private dirtyProgram: boolean;\n\n  constructor() {\n    this.canvas = document.createElement('canvas');\n    const context = this.canvas.getContext('webgl');\n\n    if (context === null) {\n      throw new Error(`Couldn't get a WebGL context`);\n    }\n\n    const gl: WebGLRenderingContext = context as WebGLRenderingContext;\n    this.context = gl;\n    const textureId = gl.createTexture();\n\n    if (textureId === null) {\n      throw new Error('Error getting texture ID');\n    }\n\n    this.textureId = textureId;\n    this.programId = 0;\n\n    this.vertShader = BASE_VERTEX_SHADER;\n    this.fragShader = BASE_FRAGMENT_SHADER;\n\n    this.uniformLocations = new Map();\n\n    this.bindBuffers(INDEX, POSITIONS, UVS);\n\n    gl.clearColor(1, 1, 1, 1);\n\n    this.dirtyProgram = true;\n  }\n\n  setImage(image: HTMLImageElement | HTMLVideoElement | HTMLCanvasElement) {\n    const gl = this.context;\n    gl.activeTexture(gl.TEXTURE0);\n    gl.bindTexture(gl.TEXTURE_2D, this.textureId);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n    // gl.generateMipmap(gl.TEXTURE_2D);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n  }\n\n  setVertexShader(source: string) {\n    this.vertShader = source;\n    this.dirtyProgram = true;\n  }\n\n  setFragmentShader(source: string) {\n    this.fragShader = source;\n    this.dirtyProgram = true;\n  }\n\n  setUniform(name: string, value: any) {\n    const gl = this.context;\n\n    if (this.dirtyProgram) {\n      this.createProgram();\n    }\n\n    if (!this.uniformLocations.has(name)) {\n      console.warn(`Tried to set unknown uniform ${name}`);\n      return;\n    }\n\n    const info = this.uniformLocations.get(name)!;\n\n    switch (info.type) {\n      case gl.FLOAT:\n        gl.uniform1fv(info.location, [value]);\n        break;\n      case gl.FLOAT_VEC2:\n        gl.uniform2fv(info.location, value);\n        break;\n      case gl.FLOAT_VEC3:\n        gl.uniform3fv(info.location, value);\n        break;\n      case gl.FLOAT_VEC4:\n        gl.uniform4fv(info.location, value);\n        break;\n      case gl.BOOL:\n      case gl.INT:\n        gl.uniform1iv(info.location, [value]);\n        break;\n      case gl.BOOL_VEC2:\n      case gl.INT_VEC2:\n        gl.uniform2iv(info.location, value);\n        break;\n      case gl.BOOL_VEC3:\n      case gl.INT_VEC3:\n        gl.uniform3iv(info.location, value);\n        break;\n      case gl.BOOL_VEC4:\n      case gl.INT_VEC4:\n        gl.uniform4iv(info.location, value);\n        break;\n      default:\n        console.error(`Couldn't set uniform, unsupported type`);\n    }\n  }\n\n  render() {\n    const gl = this.context;\n\n    if (this.dirtyProgram) {\n      this.createProgram();\n    }\n\n    gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n    gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);\n    gl.flush();\n  }\n\n  private createProgram() {\n    const gl = this.context;\n\n    const vertexShaderId = this.compileShader(this.vertShader, gl.VERTEX_SHADER);\n    const fragmentShaderId = this.compileShader(this.fragShader, gl.FRAGMENT_SHADER);\n    const programId = gl.createProgram();\n    if (programId === null) {\n      throw new Error(`Couldn't get a program ID`);\n    }\n    this.programId = programId;\n    gl.attachShader(programId, vertexShaderId);\n    gl.attachShader(programId, fragmentShaderId);\n    gl.linkProgram(programId);\n    if (!gl.getProgramParameter(programId, gl.LINK_STATUS)) {\n      const info = gl.getProgramInfoLog(programId);\n      throw new Error('Could not link shader program. \\n\\n' + info);\n    }\n    gl.validateProgram(programId);\n    if (!gl.getProgramParameter(programId, gl.VALIDATE_STATUS)) {\n      const info = gl.getProgramInfoLog(programId);\n      throw new Error('Could not validate shader program. \\n\\n' + info);\n    }\n    gl.useProgram(programId);\n    this.uniformLocations = new Map();\n    this.getUniformLocations();\n\n    this.dirtyProgram = false;\n  }\n\n  private compileShader(source: string, type: number): WebGLShader {\n    const gl = this.context;\n    const shader = gl.createShader(type);\n\n    if (shader === null) {\n      throw new Error('Error creating shader');\n    }\n\n    gl.shaderSource(shader, source);\n    gl.compileShader(shader);\n    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\n      throw new Error(`Couldn't compiler shader: ${gl.getShaderInfoLog(shader)}`);\n    }\n    return shader;\n  }\n\n  private getUniformLocations() {\n    const gl = this.context;\n    const numUniforms = gl.getProgramParameter(this.programId, gl.ACTIVE_UNIFORMS);\n    for (let i = 0; i < numUniforms; i++) {\n      const info = gl.getActiveUniform(this.programId, i);\n      if (info === null) {\n        throw new Error(`Couldn't get uniform info`);\n      }\n      const location = gl.getUniformLocation(this.programId, info.name);\n      if (location) {\n        this.uniformLocations.set(info.name, {type: info.type, location});\n      }\n    }\n  }\n\n  private bindBuffers(index: Uint16Array, positions: Float32Array, uvs: Float32Array) {\n    const gl = this.context;\n    this.bindIndicesBuffer(index);\n    this.bindAttributeBuffer(0, 2, positions);\n    this.bindAttributeBuffer(1, 2, uvs);\n    gl.enableVertexAttribArray(0);\n    gl.enableVertexAttribArray(1);\n  }\n\n  private bindAttributeBuffer(attributeNumber: number, size: number, data: Float32Array) {\n    const gl = this.context;\n    const id = gl.createBuffer();\n    gl.bindBuffer(gl.ARRAY_BUFFER, id);\n    gl.bufferData(gl.ARRAY_BUFFER, data, gl.STATIC_DRAW);\n    gl.vertexAttribPointer(attributeNumber, size, gl.FLOAT, false, 0, 0);\n    gl.bindBuffer(gl.ARRAY_BUFFER, null);\n  }\n\n  private bindIndicesBuffer(data: Uint16Array) {\n    const gl = this.context;\n    const id = gl.createBuffer();\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, id);\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, data, gl.STATIC_DRAW);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport FilterTransform from './filter-transform';\n\nexport class NamedFilter {\n  name: string;\n  values: FilterTransform;\n\n  constructor() {\n    this.name = '';\n    this.values = new FilterTransform();\n  }\n}\n\nexport const namedFilters: NamedFilter[] = [\n  {\n    name: 'Grimsby',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Slough',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Burnley',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Carlisle',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Stevenage',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Hull',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Swansea',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Luton',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Glasgow',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Dull',\n    values: new FilterTransform(),\n  },\n];\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport constants from '../constants';\nimport fragmentShader from '../filters/filter-fragment-shader.glsl';\nimport FilterTransform from '../filters/filter-transform';\nimport ImageShader from '../filters/image-shader';\nimport {NamedFilter, namedFilters} from '../filters/named-filter';\nimport ImageRecord from '../image-record';\nimport {canvasToBlob} from '../promise-helpers';\nimport router from '../router';\nimport ViewState from '../view-state';\nimport View from './view';\n\nexport default class EditView extends View {\n  private destElement: HTMLDivElement;\n  private sourceElement: HTMLImageElement | null;\n  private sourceWidth: number;\n  private sourceHeight: number;\n  private closeButton: HTMLButtonElement;\n  private acceptButton: HTMLButtonElement;\n  private sliders: Map<string, HTMLInputElement>;\n  private effectButtons: Set<HTMLButtonElement>;\n  private filterSectionButton: HTMLButtonElement;\n  private tuneSectionButton: HTMLButtonElement;\n  private filterSection: HTMLDivElement;\n  private tuneSection: HTMLDivElement;\n  private animationFrame: number;\n  private imageShader: ImageShader;\n  private currentRecord: ImageRecord | null;\n  private currentPanel: Element | null;\n  private transform: FilterTransform;\n\n  constructor() {\n    super(document.getElementById('edit-view')!);\n\n    this.destElement = document.getElementById('edit-dest')! as HTMLDivElement;\n    this.closeButton = document.getElementById('edit-view-close')! as HTMLButtonElement;\n    this.acceptButton = document.getElementById('edit-view-accept')! as HTMLButtonElement;\n    this.filterSectionButton = document.getElementById('edit-select-filters')! as HTMLButtonElement;\n    this.tuneSectionButton = document.getElementById('edit-select-tuning')! as HTMLButtonElement;\n    this.filterSection = document.getElementById('edit-filter')! as HTMLDivElement;\n    this.tuneSection = document.getElementById('edit-tune')! as HTMLDivElement;\n\n    this.closeButton.addEventListener('click', () => this.closeClick());\n    this.acceptButton.addEventListener('click', () => this.acceptClick());\n    this.filterSectionButton.addEventListener('click', () => this.toggleSection());\n    this.tuneSectionButton.addEventListener('click', () => this.toggleSection());\n\n    this.transform = new FilterTransform();\n\n    this.sliders = new Map();\n\n    const sliderElements = this.viewElement.getElementsByTagName('input');\n\n    for (const slider of Array.from(sliderElements)) {\n      this.sliders.set(slider.id, slider);\n\n      slider.addEventListener('input', () => {\n        this.transform[slider.id] = Number(slider.value) / 50;\n        if (!this.animationFrame) {\n          this.animationFrame = requestAnimationFrame(() => this.draw());\n        }\n      });\n    }\n\n    for (const filter of namedFilters) {\n      filter.values.randomize();\n\n      const button = document.createElement('button');\n      button.classList.add('filter-button');\n      button.id = `filter-button-${filter.name.toLowerCase()}`;\n      button.setAttribute('aria-label', filter.name);\n      button.tabIndex = 0;\n      button.addEventListener('click', () => this.filterButtonClick(filter));\n\n      const canvas = document.createElement('canvas');\n      canvas.classList.add('filter-thumbnail');\n      button.appendChild(canvas);\n\n      this.filterSection.appendChild(button);\n    }\n\n    this.effectButtons = new Set(this.viewElement.querySelectorAll('button.effect-button')) as Set<HTMLButtonElement>;\n\n    for (const effectButton of this.effectButtons) {\n      effectButton.addEventListener('click', () => this.effectButtonClick(effectButton));\n    }\n\n    this.imageShader = new ImageShader();\n    this.imageShader.setFragmentShader(fragmentShader);\n    this.sourceElement = null;\n    this.sourceWidth = 0;\n    this.sourceHeight = 0;\n    this.destElement.appendChild(this.imageShader.canvas);\n\n    this.currentPanel = null;\n    this.currentRecord = null;\n  }\n\n  async show() {\n    const state = this.getState();\n\n    this.setTransform(state.transform || new FilterTransform());\n\n    if (!state.id) {\n      // TODO: Better handling of errors?\n      throw new Error(`Couldn't get id of image`);\n    }\n\n    const record: ImageRecord = await ImageRecord.fromDatabase(state.id);\n    this.currentRecord = record;\n    this.setTransform(record.transform || new FilterTransform());\n    const blob = await record.getOriginal();\n\n    const source = document.createElement('img');\n    this.sourceElement = source;\n    source.onload = () => {\n      URL.revokeObjectURL(source.src);\n      this.imageShader.setImage(source);\n      this.sourceWidth = source.naturalWidth;\n      this.sourceHeight = source.naturalHeight;\n      this.animationFrame = requestAnimationFrame(() => this.draw());\n      this.renderThumbnails();\n    };\n    source.src = URL.createObjectURL(blob);\n    super.show();\n  }\n\n  hide() {\n    cancelAnimationFrame(this.animationFrame);\n    this.sourceElement = null;\n    this.animationFrame = 0;\n    this.currentRecord = null;\n    if (this.currentPanel) {\n      this.currentPanel.classList.add('hidden');\n    }\n    super.hide();\n  }\n\n  getState(): ViewState {\n    const state = super.getState();\n    state.transform = state.transform || new FilterTransform();\n    return state;\n  }\n\n  setState(state: ViewState) {\n    if (state.transform) {\n      this.setTransform(state.transform);\n    }\n    super.setState(state);\n  }\n\n  private renderThumbnails() {\n    if (!this.sourceElement) {\n      return;\n    }\n    const aspectRatio = this.sourceWidth / this.sourceHeight;\n\n    const thumbnail = document.createElement('canvas');\n    thumbnail.height = 100 * devicePixelRatio;\n    thumbnail.width = thumbnail.height * aspectRatio;\n    thumbnail.getContext('2d')!.drawImage(this.sourceElement, 0, 0, thumbnail.width, thumbnail.height);\n    const thumbShader = new ImageShader();\n    thumbShader.setFragmentShader(fragmentShader);\n    thumbShader.setImage(thumbnail);\n\n    const relativeSize = thumbnail.height / this.sourceHeight;\n\n    for (const filter of namedFilters) {\n      const output =\n        document.querySelector(`#filter-button-${filter.name.toLowerCase()} .filter-thumbnail`) as HTMLCanvasElement;\n      if (!output) {\n        console.error(`No output thumbnail for filter ${filter.name}`);\n      } else {\n        setTimeout(() => {\n          output.width = thumbnail.width;\n          output.height = thumbnail.height;\n          const context = output.getContext('2d') as CanvasRenderingContext2D;\n          thumbShader.setUniform('sourceSize', new Float32Array([1 / thumbnail.width, 1 / thumbnail.height]));\n\n          const transform = filter.values;\n          // Reduce the blur value relative to the size of the thumbnail\n          thumbShader.setUniform('blur', relativeSize * transform.blur);\n          thumbShader.setUniform('brightness', transform.brightness);\n          thumbShader.setUniform('contrast', transform.contrast);\n          thumbShader.setUniform('grey', transform.grey);\n          thumbShader.setUniform('saturation', transform.saturation);\n          thumbShader.setUniform('sharpen', transform.sharpen);\n          thumbShader.setUniform('vignette', transform.vignette);\n          thumbShader.setUniform('warmth', transform.warmth);\n          thumbShader.render();\n          context.drawImage(\n            thumbShader.canvas,\n            0, 0, thumbShader.canvas.width, thumbShader.canvas.height,\n            0, 0, output.width, output.height);\n        }, 0);\n      }\n    }\n  }\n\n  private setTransform(transform: FilterTransform | {[name: string]: number}) {\n    if (transform instanceof FilterTransform) {\n      this.transform = transform;\n    } else {\n      for (const name of Object.getOwnPropertyNames(this.transform)) {\n        if (transform[name]) {\n          this.transform[name] = transform[name];\n        }\n      }\n    }\n    for (const [id, slider] of this.sliders) {\n      slider.value = String(this.transform[id] * 50);\n    }\n  }\n\n  private draw() {\n    const canvas = this.imageShader.canvas;\n    canvas.width = this.sourceWidth;\n    canvas.height = this.sourceHeight;\n\n    this.imageShader.setUniform('sourceSize', new Float32Array([1 / canvas.width, 1 / canvas.height]));\n\n    for (const [name, value] of Object.entries(this.transform)) {\n      this.imageShader.setUniform(name, value);\n    }\n\n    this.animationFrame = 0;\n\n    this.imageShader.render();\n  }\n\n  private filterButtonClick(filter: NamedFilter) {\n    this.setTransform(filter.values);\n\n    if (!this.animationFrame) {\n      this.animationFrame = requestAnimationFrame(() => this.draw());\n    }\n  }\n\n  private effectButtonClick(button: HTMLButtonElement) {\n    const panel = this.viewElement.querySelector(`#${button.id}-panel`)!;\n\n    if (this.currentPanel) {\n      this.currentPanel.classList.add('hidden');\n\n      if (this.currentPanel !== panel) {\n        this.currentPanel = panel;\n        panel.classList.remove('hidden');\n      } else {\n        this.currentPanel = null;\n      }\n    } else {\n      this.currentPanel = panel;\n      panel.classList.remove('hidden');\n    }\n  }\n\n  private toggleSection() {\n    this.filterSection.classList.toggle('selected');\n    this.tuneSection.classList.toggle('selected');\n    this.filterSectionButton.classList.toggle('selected');\n    this.tuneSectionButton.classList.toggle('selected');\n    if (this.currentPanel) {\n      this.currentPanel.classList.add('hidden');\n      this.currentPanel = null;\n    }\n  }\n\n  private async save(): Promise<void> {\n    this.draw();\n    const blob = await canvasToBlob(this.imageShader.canvas, constants.IMAGE_TYPE);\n\n    if (this.currentRecord) {\n      this.currentRecord.setEdited(blob);\n      this.currentRecord.transform = this.transform;\n      this.currentRecord.save();\n    }\n  }\n\n  private closeClick() {\n    router.visit(`/browse`);\n  }\n\n  private acceptClick() {\n    this.save().then(() => {\n      router.visit(`/browse`);\n    });\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport ImageRecord from '../image-record';\nimport router from '../router';\nimport View from './view';\n\nexport default class UploadView extends View {\n  private uploadInput: HTMLInputElement;\n  private uploadButton: HTMLButtonElement;\n  private uploadDropTarget: HTMLDivElement;\n  private closeButton: HTMLButtonElement;\n\n  constructor() {\n    super(document.getElementById('upload-view')!);\n\n    this.uploadInput = document.getElementById('upload-file-input')! as HTMLInputElement;\n    this.uploadButton = document.getElementById('upload-button')! as HTMLButtonElement;\n    this.uploadDropTarget = document.getElementById('upload-drop-target')! as HTMLDivElement;\n    this.closeButton = document.getElementById('upload-view-close')! as HTMLButtonElement;\n\n    this.uploadInput.addEventListener('change', () => this.inputChange());\n    this.uploadButton.addEventListener('click', () => this.triggerUpload());\n    this.uploadDropTarget.addEventListener('drop', (e) => this.dropHandler(e));\n    this.uploadDropTarget.addEventListener('dragover', (e) => this.dragOverHandler(e));\n    this.closeButton.addEventListener('click', () => this.close());\n  }\n\n  inputChange() {\n    this.ingest(this.uploadInput.files!);\n  }\n\n  triggerUpload() {\n    this.uploadInput.click();\n  }\n\n  dragOverHandler(e: DragEvent) {\n    e.stopPropagation();\n    e.preventDefault();\n    e.dataTransfer.dropEffect = 'copy';\n  }\n\n  dropHandler(e: DragEvent) {\n    e.stopPropagation();\n    e.preventDefault();\n\n    this.ingest(e.dataTransfer.files);\n  }\n\n  async ingest(files: FileList) {\n    if (files.length === 0) {\n      return;\n    }\n    const file = files[0];\n    const record = new ImageRecord();\n    record.setOriginal(file);\n    await record.save();\n    router.visit(`/edit/${record.id}`);\n  }\n\n  close() {\n    router.visit(`/browse`);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport ViewState from './view-state';\nimport BrowseView from './views/browse-view';\nimport CaptureView from './views/capture-view';\nimport EditView from './views/edit-view';\nimport UploadView from './views/upload-view';\nimport View from './views/view';\n\nclass Router {\n  private currentView: View | null;\n  private currentLocation: string;\n\n  private browseView: BrowseView;\n  private captureView: CaptureView;\n  private editView: EditView;\n  private uploadView: UploadView;\n\n  constructor() {\n    window.addEventListener('popstate', (e) => this.changeHandler(e.state));\n\n    this.browseView = new BrowseView();\n    this.captureView = new CaptureView();\n    this.editView = new EditView();\n    this.uploadView = new UploadView();\n  }\n\n  changeHandler(state?: ViewState) {\n    // TODO: Not sure that I should take the state here\n\n    // Ignore any changes in the hash.\n    if (window.location.pathname === this.currentLocation) {\n      return;\n    }\n    this.currentLocation = window.location.pathname;\n\n    const parts = this.currentLocation.split('/');\n\n    if (this.currentView) {\n      this.currentView.hide();\n    }\n\n    if (!state) {\n      state = new ViewState();\n    }\n\n    let newView: View | null = null;\n\n    switch (parts[1]) {\n      case 'capture':\n        newView = this.captureView;\n        break;\n      case '': // Entry point\n      case 'browse':\n        newView = this.browseView;\n        break;\n      case 'edit':\n        newView = this.editView;\n        state.id = Number(parts[2]);\n        break;\n      case 'upload':\n        newView = this.uploadView;\n        break;\n      default:\n        // TODO: Proper 404\n        console.log('404');\n    }\n\n    if (newView) {\n      this.switch(newView, state);\n    } else {\n      // TODO: Something better?\n      console.log('Oh no, no view found!');\n    }\n  }\n\n  switch(newView: View, state: ViewState) {\n    if (this.currentView) {\n      this.currentView.hide();\n    }\n    newView.setState(state);\n    newView.show();\n    this.currentView = newView;\n  }\n\n  visit(url: string) {\n    if (window.location.href === url) {\n      return;\n    }\n\n    let state;\n\n    if (this.currentView) {\n      state = this.currentView.getState();\n    }\n\n    window.history.replaceState(state, '', window.location.href);\n    window.history.pushState(null, '', url);\n    this.changeHandler();\n  }\n\n  click(event: MouseEvent) {\n    const anchor = event.target as HTMLAnchorElement;\n\n    if (event.metaKey || event.ctrlKey || event.button !== 0) {\n      return;\n    }\n\n    event.preventDefault();\n    this.visit(anchor.href);\n  }\n}\n\nexport default new Router();\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport router from './router';\n\nif ('serviceWorker' in navigator) {\n  navigator.serviceWorker.register('/sw.js');\n}\n\nrouter.changeHandler();\n"],"names":["IMAGE_TYPE","SUPPORTS_IMAGE_CAPTURE","window","SUPPORTS_MEDIA_DEVICES","navigator","random","Math","from","FilterTransform","saturation","warmth","sharpen","blur","brightness","contrast","grey","vignette","constructor","randomize","atob","split","Uint8Array","length","charCodeAt","buffer","toBlob","Promise","toDataURL","dataUrlToArrayBuffer","Blob","type","FileReader","addEventListener","result","readAsArrayBuffer","DB_VERSION","indexedDB","open","dbPromise","dbResolve","dbReject","onerror","onupgradeneeded","createObjectStore","onsuccess","dbOpened","storeRecord","id","then","transaction","objectStore","put","catch","retrieveRecord","get","storeMedia","blobToArrayBuffer","media","retrieveMedia","all","openCursor","push","value","continue","error","console","target","autoIncrement","keyPath","oldVersion","upgrade2to3","deleteObjectStore","editedId","guid","originalId","thumbnailId","transform","original","edited","db","imageDB","ImageDB","ImageState","fromDatabase","ImageRecord","fromListRecord","originalState","NotLoaded","editedState","thumbnailState","getAll","Changed","originalCache","editedCache","thumbnailCache","getOriginal","Loaded","getEdited","getThumbnail","setOriginal","setEdited","save","viewElement","show","classList","remove","hide","add","getState","state","ViewState","setState","View","document","getElementById","captureButton","uploadButton","emptyListElement","listElement","constants","captureClick","uploadClick","blobURLs","Set","createElement","router","visit","URL","createObjectURL","src","appendChild","hasChildNodes","removeChild","lastChild","revokeObjectURL","clear","streamConstraints","video","deviceId","facingMode","height","ideal","width","supportedConstraints","mediaDevices","getSupportedConstraints","stream","track","photoCapabilities","trackConstraints","flash","getCameras","enumerateDevices","filter","kind","takePhoto","srcObject","getVideoTracks","ImageCapture","fillLightMode","includes","getContext","videoWidth","videoHeight","drawImage","canvasToBlob","stopStream","stop","startStream","getUserMedia","getPhotoCapabilities","redEyeReduction","getSettings","videoElement","querySelector","videoElement2","takePhotoButton","cameraChooseButton","mirrorButton","flashButton","closeButton","cameraHelper","CameraHelper","toggleCameraChooser","toggleMirror","toggleFlash","close","devicesPromise","getDevices","currentDevice","chooseCamera","pause","storeResult","indexOf","onloadedmetadata","play","toggle","BASE_VERTEX_SHADER","BASE_FRAGMENT_SHADER","POSITIONS","Float32Array","UVS","INDEX","Uint16Array","canvas","Error","context","createTexture","textureId","programId","vertShader","fragShader","uniformLocations","Map","bindBuffers","clearColor","dirtyProgram","setImage","activeTexture","TEXTURE0","bindTexture","TEXTURE_2D","texImage2D","RGBA","UNSIGNED_BYTE","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","TEXTURE_MIN_FILTER","LINEAR","TEXTURE_MAG_FILTER","setVertexShader","setFragmentShader","setUniform","createProgram","has","warn","FLOAT","uniform1fv","location","FLOAT_VEC2","uniform2fv","FLOAT_VEC3","uniform3fv","FLOAT_VEC4","uniform4fv","BOOL","INT","uniform1iv","BOOL_VEC2","INT_VEC2","uniform2iv","BOOL_VEC3","INT_VEC3","uniform3iv","BOOL_VEC4","INT_VEC4","uniform4iv","render","viewport","drawingBufferWidth","drawingBufferHeight","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","drawElements","TRIANGLES","UNSIGNED_SHORT","flush","compileShader","VERTEX_SHADER","FRAGMENT_SHADER","attachShader","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","validateProgram","VALIDATE_STATUS","useProgram","getUniformLocations","createShader","shaderSource","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","ACTIVE_UNIFORMS","getActiveUniform","getUniformLocation","name","set","bindIndicesBuffer","bindAttributeBuffer","enableVertexAttribArray","createBuffer","bindBuffer","ARRAY_BUFFER","bufferData","STATIC_DRAW","vertexAttribPointer","ELEMENT_ARRAY_BUFFER","namedFilters","values","destElement","acceptButton","filterSectionButton","tuneSectionButton","filterSection","tuneSection","closeClick","acceptClick","toggleSection","sliders","getElementsByTagName","Array","animationFrame","requestAnimationFrame","draw","toLowerCase","setAttribute","tabIndex","filterButtonClick","effectButtons","querySelectorAll","effectButtonClick","imageShader","ImageShader","fragmentShader","sourceElement","sourceWidth","sourceHeight","currentPanel","currentRecord","setTransform","onload","naturalWidth","naturalHeight","renderThumbnails","cancelAnimationFrame","devicePixelRatio","setTimeout","Object","getOwnPropertyNames","entries","uploadInput","uploadDropTarget","inputChange","triggerUpload","dropHandler","dragOverHandler","ingest","files","click","stopPropagation","preventDefault","dataTransfer","dropEffect","changeHandler","browseView","BrowseView","captureView","CaptureView","editView","EditView","uploadView","UploadView","pathname","currentLocation","currentView","log","switch","href","history","replaceState","pushState","metaKey","ctrlKey","button","Router","serviceWorker","register"],"mappings":"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"}